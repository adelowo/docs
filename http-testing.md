# Testing HTTP Applications

## Table of Contents
1. [Introduction](#introduction)
2. [route()](#route)
3. [assertRedirectsTo()](#assert-redirects-to)
4. [assertResponseContentEquals()](#assert-response-content-equals)
5. [assertResponseCookieValueEquals()](#assert-response-cookie-value-equals)
6. [assertResponseHasCookie()](#assert-response-has-cookie)
7. [assertResponseHasHeader()](#assert-response-has-header)
8. [assertResponseHeaderEquals()](#assert-response-header-equals)
9. [assertResponseIsInternalServerError()](#assert-response-is-internal-server-error)
10. [assertResponseIsNotFound()](#assert-response-is-not-found)
11. [assertResponseStatusCodeEquals()](#assert-response-status-code-equals)
12. [assertResponseIsUnauthorized()](#assert-response-is-unauthorized)
13. [assertViewHasTag()](#assert-view-has-tag)
14. [assertViewHasVar()](#assert-view-has-var)
15. [assertViewTagEquals()](#assert-view-tag-equals)
16. [assertViewVarEquals()](#assert-view-var-equals)
17. [Middleware](#middleware)
  1. [Disabling All Middleware](#disabling-all-middleware)
  2. [Disabling Specific Middleware](#disabling-specific-middleware)
  3. [Enabling Specific Middleware](#enabling-specific-middleware)

<h2 id="introduction">Introduction</h2>
Opulence gives you a powerful integration testing tool to simulate routes and test the responses and views created by controllers.  The tool is the `Opulence\Framework\Tests\HTTP\ApplicationTestCase` class, which extends PHPUnit's `PHPUnit_Framework_TestCase`.  By extending `ApplicationTestCase`, you'll inherit the following methods to test your HTTP application:

> **Note:** If you need to define a `setUp()` or `tearDown()` method in your test, make sure to call `parent::setUp()` or `parent::tearDown()`.

<h2 id="route">route()</h2>
Allows you to simulate an HTTP method and path.  It returns the `Response` generated by the matched controller.  You can include a `Request` object as an optional last parameter to pass in things like request cookies or headers.

> **Note:**  This must be called before any assertions in this class.

<h2 id="assert-redirects-to">assertRedirectsTo()</h2>
Asserts that the response is a redirect to a particular URL:

```php
public function testMyRedirect()
{
    $this->route("GET", "/myaccount");
    $this->assertRedirectsTo("/login");
}
```

<h2 id="assert-response-content-equals">assertResponseContentEquals()</h2>
Asserts that the response's content matches an expected value:

```php
public function testContent()
{
    $this->route("GET", "/404");
    $this->assertResponseContentEquals("Page not found");
}
```

<h2 id="assert-response-cookie-value-equals">assertResponseCookieValueEquals()</h2>
Asserts that a response cookie matches an expected value:

```php
public function testCheckingVisitedCookie()
{
    $this->route("GET", "/home");
    $this->assertResponseCookieValueEquals("visited", "1");
}
```

<h2 id="assert-response-has-cookie">assertResponseHasCookie()</h2>
Asserts that a response has a cookie with a particular name:

```php
public function testCheckingVisitedCookie()
{
    $this->route("GET", "/home");
    $this->assertResponseHasCookie("visited");
}
```

<h2 id="assert-response-has-header">assertResponseHasHeader()</h2>
Asserts that a response has a header with a particular name:

```php
public function testCheckingCacheControl()
{
    $this->route("GET", "/profile");
    $this->assertResponseHasHeader("cache-control");
}
```

<h2 id="assert-response-header-equals">assertResponseHeaderEquals()</h2>
Asserts that a response header matches an expected value:

```php
public function testCheckingCacheControl()
{
    $this->route("GET", "/profile");
    $this->assertResponseHeaderEquals("cache-control", "no-cache, must-revalidate");
}
```

<h2 id="assert-response-is-internal-server-error">assertResponseIsInternalServerError()</h2>
Asserts that a response is an internal server error:

```php
public function testBadRequest()
{
    $this->route("GET", "/500");
    $this->assertResponseIsInternalServerError();
}
```

<h2 id="assert-response-is-not-found">assertResponseIsNotFound()</h2>
Asserts that a response is not found:

```php
public function test404()
{
    $this->route("GET", "/404");
    $this->assertResponseIsNotFound();
}
```

<h2 id="assert-response-is-ok">assertResponseIsOK()</h2>
Asserts that a response is OK:

```php
public function testHomepage()
{
    $this->route("GET", "/");
    $this->assertResponseIsOK();
}
```

<h2 id="assert-response-status-code-equals">assertResponseStatusCodeEquals()</h2>
Asserts that a response's status code equals a particular value:

```php
public function testPaymentRequiredOnSubscriptionPage()
{
    $this->route("GET", "/subscribers/reports");
    $this->assertResponseStatusCodeEquals(ResponseHeaders::HTTP_PAYMENT_REQUIRED);
}
```

<h2 id="assert-response-is-unauthorized">assertResponseIsUnauthorized()</h2>
Asserts that a response is not authorized:

```php
public function testUserListPageWhenNotLoggedIn()
{
    $this->route("GET", "/users");
    $this->assertResponseIsUnauthorized();
}
```

<h2 id="assert-view-has-tag">assertViewHasTag()</h2>
Asserts that the view generated by the controller has a particular tag:

```php
public function testTitleIsSet()
{
    $this->route("GET", "/home");
    $this->assertViewHasTag("title");
}
```

> **Note:** This is only available if your controller extends `Opulence\Routing\Controller`.

<h2 id="assert-view-has-var">assertViewHasVar()</h2>
Asserts that the view generated by the controller has a particular variable:

```php
public function testCSSVariableIsSet()
{
    $this->route("GET", "/home");
    $this->assertViewHasVar("css");
}
```

> **Note:** This is only available if your controller extends `Opulence\Routing\Controller`.

<h2 id="assert-view-tag-equals">assertViewTagEquals()</h2>
Asserts that the view generated by the controller has a particular tag with an expected value:

```php
public function testTitleIsSet()
{
    $this->route("GET", "/home");
    $this->assertViewTagEquals("title", "Home");
}
```

> **Note:** This is only available if your controller extends `Opulence\Routing\Controller`.

<h2 id="assert-view-var-equals">assertViewVarEquals()</h2>
Asserts that the view generated by the controller has a particular variable with an expected value:

```php
public function testCSSVariableIsSet()
{
    $this->route("GET", "/home");
    $this->assertViewVarEquals("css", ["assets/css/style.css"]);
}
```

> **Note:** This is only available if your controller extends `Opulence\Routing\Controller`.

<h2 id="middleware">Middleware</h2>
You can customize which middleware are run in your tests.

<h4 id="disabling-all-middleware">Disabling All Middleware</h4>
You may disable all middleware in your kernel:

```php
public function testWithoutMiddleware()
{
    $this->getKernel()->disableAllMiddleware();
    // ...Do your tests
}
```

<h4 id="disabling-specific-middleware">Disabling Specific Middleware</h4>
You may disable only specific middleware in your kernel:

```php
public function testWithoutSpecificMiddleware()
{
    $this->getKernel()->onlyDisableMiddleware(["MyMiddlewareClass"]);
    // ...Do your tests
}
```

<h4 id="enabling-specific-middleware">Enabling Specific Middleware</h4>
You may enable only specific middleware in your kernel:

```php
public function testWithSpecificMiddleware()
{
    $this->getKernel()->onlyEnableMiddleware(["MyMiddlewareClass"]);
    // ...Do your tests
}
```