# Testing Your Application

## Table of Contents
1. [Introduction](#introduction)
  1. [Test Driven Development](#test-driven-development)
  2. [PHPUnit](#php-unit)
2. [Testing an HTTP Application](#testing-an-http-application)
  1. [route()](#route)
  2. [assertRedirectsTo()](#assert-redirects-to)
  3. [assertResponseContentEquals()](#assert-response-content-equals)
  4. [assertResponseCookieValueEquals()](#assert-response-cookie-value-equals)
  5. [assertResponseHasCookie()](#assert-response-has-cookie)
  6. [assertResponseHasHeader()](#assert-response-has-header)
  7. [assertResponseHeaderEquals()](#assert-response-header-equals)
  8. [assertResponseIsInternalServerError()](#assert-response-is-internal-server-error)
  9. [assertResponseIsNotFound()](#assert-response-is-not-found)
  10. [assertResponseStatusCodeEquals()](#assert-response-status-code-equals)
  11. [assertResponseIsUnauthorized()](#assert-response-is-unauthorized)
  12. [assertTemplateHasTag()](#assert-template-has-tag)
  13. [assertTemplateHasVar()](#assert-template-has-var)
  14. [assertTemplateTagEquals()](#assert-template-tag-equals)
  15. [assertTemplateVarEquals()](#assert-template-var-equals)
3. [Testing a Console Application](#testing-a-console-application)
  1. [call()](#call)
  2. [assertOutputEquals()](#assert-output-equals)
  3. [assertStatusCodeEquals()](#assert-status-code-equals)
  4. [assertStatusCodeIsError()](#assert-status-code-is-error)
  5. [assertStatusCodeIsFatal()](#assert-status-code-is-fatal)
  6. [assertStatusCodeIsOK()](#assert-status-code-is-ok)
  7. [assertStatusCodeIsWarning()](#assert-status-code-is-warning)
  8. [getOutput()](#get-output)

<h2 id="introduction">Introduction</h2>
Have you ever written a new feature only to find that it broke previously-working code?  Has something like this every slipped into your production code?  Well, unit testing is a great way to prevent this.  Basically, you write tests for all the public methods in your classes and simulate all sorts of user input to test both normal and edge cases.  When you add a new feature, you write tests to handle the new functionality.  If all of your previously-written tests still pass, you can rest easy knowing your code does not have any regressions.  Otherwise, you can patch any bugs exposed by the new feature.

<h4 id="test-driven-development">Test-Driven Development</h4>
*Test Driven Development* is a programming methodology that entails writing your tests, and *then* writing your classes.  This gets you thinking about what your class will need to handle, which is a good way of determining if a class is well-thought-out.  This may seem counter-intuitive at first, but it is a phenomenal way to improve a class' interface and usability before writing any actual code in the class.

<h4 id="php-unit">PHPUnit</h4>
<a href="https://phpunit.de/" target="_blank" title="PHPUnit">PHPUnit</a> is a popular unit testing framework for PHP.  It is used extensively by RDev itself.

<h2 id="testing-an-http-application">Testing an HTTP Application</h2>
RDev gives you a powerful tool to simulate routes and test the responses and templates created by controllers.  The tool is the `RDev\Framework\Tests\HTTP\ApplicationTestCase` class, which extends PHPUnit's `PHPUnit_Framework_TestCase`.  By extending `ApplicationTestCase`, you'll inherit the following methods to test your HTTP application:

<h4 id="route">route()</h4>
Allows you to simulate an HTTP method and path.  It returns the `Response` generated by the matched controller.  You can include a `Request` object as an optional last parameter to pass in things like request cookies or headers.

> **Note:**  This must be called before any assertions in this class.

<h4 id="assert-redirects-to">assertRedirectsTo()</h4>
Asserts that the response is a redirect to a particular URL:

```php
public function testMyRedirect()
{
    $this->route("GET", "/myaccount");
    $this->assertRedirectsTo("/login");
}
```

<h4 id="assert-response-content-equals">assertResponseContentEquals()</h4>
Asserts that the response's content matches an expected value:

```php
public function testContent()
{
    $this->route("GET", "/404");
    $this->assertResponseContentEquals("Page not found");
}
```

<h4 id="assert-response-cookie-value-equals">assertResponseCookieValueEquals()</h4>
Asserts that a response cookie matches an expected value:

```php
public function testCheckingVisitedCookie()
{
    $this->route("GET", "/home");
    $this->assertResponseCookieValueEquals("visited", "1");
}
```

<h4 id="assert-response-has-cookie">assertResponseHasCookie()</h4>
Asserts that a response has a cookie with a particular name:

```php
public function testCheckingVisitedCookie()
{
    $this->route("GET", "/home");
    $this->assertResponseHasCookie("visited");
}
```

<h4 id="assert-response-has-header">assertResponseHasHeader()</h4>
Asserts that a response has a header with a particular name:

```php
public function testCheckingCacheControl()
{
    $this->route("GET", "/profile");
    $this->assertResponseHasHeader("cache-control");
}
```

<h4 id="assert-response-header-equals">assertResponseHeaderEquals()</h4>
Asserts that a response header matches an expected value:

```php
public function testCheckingCacheControl()
{
    $this->route("GET", "/profile");
    $this->assertResponseHeaderEquals("cache-control", "no-cache, must-revalidate");
}
```

<h4 id="assert-response-is-internal-server-error">assertResponseIsInternalServerError()</h4>
Asserts that a response is an internal server error:

```php
public function testBadRequest()
{
    $this->route("GET", "/500");
    $this->assertResponseIsInternalServerError();
}
```

<h4 id="assert-response-is-not-found">assertResponseIsNotFound()</h4>
Asserts that a response is not found:

```php
public function test404()
{
    $this->route("GET", "/404");
    $this->assertResponseIsNotFound();
}
```

<h4 id="assert-response-is-not-found">assertResponseIsOK()</h4>
Asserts that a response is OK:

```php
public function testHomepage()
{
    $this->route("GET", "/");
    $this->assertResponseIsOK();
}
```

<h4 id="assert-response-status-code-equals">assertResponseStatusCodeEquals()</h4>
Asserts that a response's status code equals a particular value:

```php
public function testPaymentRequiredOnSubscriptionPage()
{
    $this->route("GET", "/subscribers/reports");
    $this->assertResponseStatusCodeEquals(ResponseHeaders::HTTP_PAYMENT_REQUIRED);
}
```

<h4 id="assert-response-is-unauthorized">assertResponseIsUnauthorized()</h4>
Asserts that a response is not authorized:

```php
public function testUserListPageWhenNotLoggedIn()
{
    $this->route("GET", "/users");
    $this->assertResponseIsUnauthorized();
}
```

<h4 id="assert-template-has-tag">assertTemplateHasTag()</h4>
Asserts that the template generated by the controller has a particular tag:

```php
public function testTitleIsSet()
{
    $this->route("GET", "/home");
    $this->assertTemplateHasTag("title");
}
```

<h4 id="assert-template-has-var">assertTemplateHasVar()</h4>
Asserts that the template generated by the controller has a particular variable:

```php
public function testCSSVariableIsSet()
{
    $this->route("GET", "/home");
    $this->assertTemplateHasVar("css");
}
```

<h4 id="assert-template-tag-equals">assertTemplateTagEquals()</h4>
Asserts that the template generated by the controller has a particular tag with an expected value:

```php
public function testTitleIsSet()
{
    $this->route("GET", "/home");
    $this->assertTemplateTagEquals("title", "Home");
}
```

<h4 id="assert-template-var-equals">assertTemplateVarEquals()</h4>
Asserts that the template generated by the controller has a particular variable with an expected value:

```php
public function testCSSVariableIsSet()
{
    $this->route("GET", "/home");
    $this->assertTemplateVarEquals("css", ["assets/css/style.css"]);
}
```

<h2 id="testing-a-console-application">Testing a Console Application</h2>
RDev comes with the ability to unit test your console commands using `RDev\Framework\Tests\Console\ApplicationTestCase`.  With it, you can test the output of your commands, simulate responses to prompt questions, and check the status code of the kernel.  Simply extend `ApplicationTestCase` in your test classes, and you'll inherit the following methods to help test your console application:

<h4 id="call">call()</h4>
Allows you to simulate a call to a console command.  It accepts:

* The command name
* The array of argument values
* The array of option values
* The answer or array of answers to use in any prompts
* Whether or not to style the output

Let's say that our command has a `Confirmation` question that we want to try testing with `true` and `false` responses:

```php
public function testConfirmation()
{
    $this->call("app:rename", ["Project", "MyApp"], [], true);
    $this->assertOutputEquals("Updated name successfully");
    $this->call("app:rename", ["Project", "MyApp"], [], false);
    $this->assertOutputEquals("Aborted");
}
```

> **Note:**  This must be called before any assertions in this class.

<h4 id="assert-output-equals">assertOutputEquals()</h4>
Asserts that the output of the last command equals an expected value:

```php
public function testOutputIsCorrect()
{
    $this->call("hello");
    $this->assertOutputEquals("Hello, world");
}
```

<h4 id="assert-status-code-equals">assertStatusCodeEquals()</h4>
Asserts that the status code of the last command equals an expected value:

```php
public function testStatusCode()
{
    $this->call("hello");
    $this->assertStatusCodeEquals(StatusCodes::WARNING);
}
```

<h4 id="assert-status-code-is-error">assertStatusCodeIsError()</h4>
Asserts that the status code of the last command is an error:

```php
public function testStatusCode()
{
    $this->call("errorcommand");
    $this->assertStatusCodeIsError();
}
```

<h4 id="assert-status-code-is-fatal">assertStatusCodeIsFatal()</h4>
Asserts that the status code of the last command is fatal:

```php
public function testStatusCode()
{
    $this->call("badcommand");
    $this->assertStatusCodeIsFatal();
}
```

<h4 id="assert-status-code-is-ok">assertStatusCodeIsOK()</h4>
Asserts that the status code of the last command is OK:

```php
public function testStatusCode()
{
    $this->call("goodcommand");
    $this->assertStatusCodeIsOK();
}
```

<h4 id="assert-status-code-is-warning">assertStatusCodeIsWarning()</h4>
Asserts that the status code of the last command is a warning:

```php
public function testStatusCode()
{
    $this->call("warningcommand");
    $this->assertStatusCodeIsWarning();
}
```

<h4 id="get-output">getOutput()</h4>
Gets the output from the last command:

```php
public function testOutput()
{
    $this->call("hello");
    $this->assertNotEquals("Goodbye, world", $this->getOutput());
}
```